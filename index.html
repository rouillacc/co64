<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≤ Course d'Orientation Connect√©e üß≠</title>
    <style>
        /* Styles g√©n√©raux pour le corps et le conteneur principal */
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #3a5a40; /* Vert for√™t fonc√© */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 25px auto;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.98); /* Blanc l√©g√®rement transparent */
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
            border: 2px solid #588157; /* Vert for√™t plus clair */
        }
        h1 {
            color: #344e41; /* Vert tr√®s fonc√© */
            text-align: center;
            margin-bottom: 35px;
            font-size: 2.5em;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.15);
        }

        /* Styles des sections de formulaire */
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(233, 242, 230, 0.8); /* Vert tr√®s clair/blanc cass√© */
            border-radius: 12px;
            border: 1px solid #a3b18a; /* Vert-gris */
        }
        .form-section h2 {
            margin-top: 0;
            color: #3a5a40;
            font-size: 1.7em;
            border-bottom: 3px solid #588157;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }

        /* Styles des labels et champs de saisie */
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #3a5a40;
        }
        select, input[type="text"], input[type="number"], input[type="password"] {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid #a3b18a;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fdfdfd; /* Blanc presque pur */
        }
        select:focus, input:focus {
            border-color: #588157;
            box-shadow: 0 0 10px rgba(88, 129, 87, 0.4);
            outline: none;
        }

        /* Styles pour les groupes de s√©lection (ex: classe, √©l√®ve, parcours) */
        .selection-groupe {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        /* Styles sp√©cifiques pour les groupes de saisie de temps (minutes et secondes) */
        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .time-input-group select {
            flex: 1; /* Permet aux selects de prendre l'espace disponible */
            margin-bottom: 0; /* Supprime la marge en bas car d√©j√† dans un groupe */
        }
        .time-input-group span {
            font-weight: bold;
            font-size: 1.2em;
            color: #3a5a40;
        }

        /* Styles pour les groupes de balises */
        .tag-group {
            border: 2px dashed #588157;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
        }
        .tag-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
            align-items: end;
        }

        /* Styles des boutons */
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button#submitBtn {
            background-color: #2a9d8f; /* Turquoise */
            color: white;
            width: 100%;
            margin-top: 20px;
        }
        /* Styles pour les r√©sultats de la v√©rification des balises */
        #resultsList li {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            font-weight: 500;
            border-left-width: 6px;
            border-left-style: solid;
        }
        .result-correct { background-color: #d1fadf; color: #006400; border-left-color: #28a745; } /* Vert clair / Vert fonc√© */
        .result-incorrect { background-color: #fde2e2; color: #a80000; border-left-color: #dc3545; } /* Rouge clair / Rouge fonc√© */
        .result-warning { background-color: #fff8e1; color: #8d6e63; border-left-color: #ffc107; } /* Jaune clair / Marron orang√© */

        /* Styles pour la zone de score final */
        #scoreArea {
            display: none; /* Masqu√© par d√©faut */
            margin-top: 25px;
            padding: 25px;
            background-color: #e0f2f1; /* Bleu-vert tr√®s clair */
            border: 3px solid #4db6ac; /* Bleu-vert */
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #004d40; /* Bleu-vert tr√®s fonc√© */
        }

        /* Message d'erreur global */
        .error-message {
            color: #c62828; /* Rouge fonc√© */
            font-size: 0.95em;
            margin-top: -10px;
            margin-bottom: 10px;
            font-weight: 500;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        
        /* Styles pour le s√©lecteur de vue (√âl√®ve/Professeur) */
        #viewSelector {
            text-align: center;
            margin-bottom: 30px;
        }
        .view-btn {
            background-color: #e76f51; /* Orange-rouge */
            color: white;
            margin: 0 10px;
            min-width: 200px;
        }
        .view-btn.active {
            background-color: #344e41; /* Vert tr√®s fonc√© (actif) */
        }

        /* Styles du tableau de bord du professeur */
        #teacherDashboard {
            border-top: 5px solid #344e41;
            margin-top: 30px;
            padding-top: 20px;
        }
        #teacherDashboard h2 {
            font-size: 2em;
        }
        .dashboard-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap; /* Permet aux boutons de passer √† la ligne sur petits √©crans */
        }
        .control-btn {
            background-color: #f4a261; /* Orange */
            color: white;
        }
        /* Styles du tableau des r√©sultats */
        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #resultsTable th, #resultsTable td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }
        #resultsTable th {
            background-color: #588157; /* Vert clair */
            color: white;
            font-size: 1.1em;
        }
        #resultsTable tr:nth-child(even) {
            background-color: #f2f2f2; /* Lignes paires gris clair */
        }
        #lessonStatus {
            text-align: center;
            font-style: italic;
            color: #3a5a40;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
    </style>


</head>
<body>

    <div class="container">
        <h1>üå≤ Course d'Orientation Connect√©e üß≠</h1>

        <div id="viewSelector">
            <button id="studentViewBtn" class="view-btn">üì± Vue √âl√®ve</button>
            <button id="teacherViewBtn" class="view-btn">üñ•Ô∏è Vue Professeur</button>
        </div>
        
        <p id="globalError" class="error-message" style="text-align:center; font-size:1.1em;"></p>

        <div id="studentView" class="hidden">
            <div id="activeLessonBanner" style="text-align:center; padding:12px 20px; margin-bottom:20px; background-color:#344e41; color:white; border-radius:10px; font-size:1.2em; font-weight:bold;">üìã Chargement de la le√ßon...</div>
            <form id="tagForm">
                <div class="form-section">
                    <h2>üèÉ‚Äç‚ôÄÔ∏è Identification üèÉ‚Äç‚ôÇÔ∏è</h2>
                    <div class="selection-groupe">
                        <div>
                            <label for="classeSelect">üè´ Classe :</label>
                            <select id="classeSelect" required></select>
                        </div>
                        <div>
                            <label for="teamSelect">üë• Num√©ro de l'El√®ve :</label>
                            <select id="teamSelect" required></select>
                        </div>
                        <div>
                            <label for="parcoursSelect">üó∫Ô∏è Nom du Parcours :</label>
                            <select id="parcoursSelect" required></select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>‚è±Ô∏è Temps de Course üèÅ</h2>
                    <label>‚è≥ Dur√©e totale (MM:SS) :</label>
                    <div class="time-input-group" style="max-width:280px;">
                        <input type="number" id="durationMinutes" min="0" max="99" placeholder="Min" style="text-align:center; font-size:1.3em; font-weight:bold;" required>
                        <span style="font-size:1.5em; font-weight:bold;">:</span>
                        <input type="number" id="durationSeconds" min="0" max="59" placeholder="Sec" style="text-align:center; font-size:1.3em; font-weight:bold;" required>
                    </div>
                    <p style="color:#588157; font-size:0.9em; margin-top:6px;">Entrez la dur√©e totale de la course (ex: 12 min et 34 sec)</p>
                </div>

                <div class="form-section">
                    <h2>üè∑Ô∏è Saisie des Balises (5 max)</h2>
                    <div id="tagEntriesContainer"></div>
                </div>

                <button type="submit" id="submitBtn">üöÄ V√©rifier et Envoyer le R√©sultat !</button>
            </form>

            <div id="resultsContainer">
                <ul id="resultsList"></ul>
            </div>
            <div id="scoreArea"></div>
        </div>

        <div id="teacherLoginContainer" class="hidden form-section">
            <h2>üîê Acc√®s Professeur</h2>
            <p>Veuillez entrer le code d'acc√®s pour continuer.</p>
            <label for="teacherCodeInput">Code :</label>
            <input type="password" id="teacherCodeInput" placeholder="Entrez le code" autocomplete="off">
            <p id="teacherCodeError" class="error-message"></p>
            <button type="button" id="teacherCodeSubmitBtn" class="control-btn" style="background-color: #588157; color: white;">Valider le code</button>
        </div>

        <div id="teacherDashboard" class="hidden">
            <h2>üìä Tableau de Bord en Temps R√©el</h2>
            <div id="lessonStatus">Aucune le√ßon d√©marr√©e.</div>
            <div class="dashboard-controls">
                <button id="startLessonBtn" class="control-btn">‚ñ∂Ô∏è D√©marrer une Nouvelle Le√ßon</button>
                <button id="exportPdfBtn" class="control-btn" disabled>üìÑ Exporter en PDF</button>
            </div>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Classe</th>
                        <th>√âl√®ve</th>
                        <th>Parcours</th>
                        <th>Score</th>
                        <th>Temps</th>
                        <th>Heure</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
// --- CONFIGURATION DE L'APPLICATION ---
const DONNEES_SHEET = { /* Base de donn√©es des balises */
            1: { BLEU: "F2", NOIR: "G1", ORANGE: "RR", VERT: "CL", ROSE: "2F", GRIS: "LX", ROUGE: "7L", MARRON: "6C" },
            2: { BLEU: "8H", NOIR: "MV", ORANGE: "HA", VERT: "O8", ROSE: "BL", GRIS: "BP", ROUGE: "3I", MARRON: "PT" },
            3: { BLEU: "NK", NOIR: "I5", ORANGE: "A5", VERT: "7T", ROSE: "CX", GRIS: "B6", ROUGE: "1T", MARRON: "6J" },
            4: { BLEU: "T8", NOIR: "HC", ORANGE: "7T", VERT: "8E", ROSE: "94", GRIS: "CV", ROUGE: "0R", "MARRON": "E2" },
            5: { BLEU: "JA", NOIR: "0E", ORANGE: "V8", VERT: "KC", ROSE: "5D", GRIS: "BY", ROUGE: "25", MARRON: "H5" },
            6: { BLEU: "VQ", NOIR: "0Y", ORANGE: "GO", VERT: "L0", ROSE: "YM", GRIS: "YH", ROUGE: "CS", MARRON: "F0" },
            7: { BLEU: "28", NOIR: "8A", ORANGE: "QU", VERT: "I7", ROSE: "YI", GRIS: "KK", ROUGE: "LZ", MARRON: "TP" },
            8: { BLEU: "ZR", NOIR: "4E", ORANGE: "PK", VERT: "D5", ROSE: "I8", GRIS: "RQ", ROUGE: "U6", MARRON: "4T" },
            9: { BLEU: "93", NOIR: "2A", ORANGE: "JP", VERT: "C1", ROSE: "TM", GRIS: "UF", ROUGE: "LA", MARRON: "EI" },
            10: { BLEU: "K3", NOIR: "U7", ORANGE: "VP", VERT: "KM", ROSE: "S8", GRIS: "9C", ROUGE: "NC", MARRON: "9W" },
            11: { BLEU: "CO", NOIR: "MV", ORANGE: "63", VERT: "RD", ROSE: "19", GRIS: "VW", ROUGE: "IG", MARRON: "TA" },
            12: { BLEU: "IA", NOIR: "9T", ORANGE: "P7", VERT: "QP", ROSE: "3E", GRIS: "GC", ROUGE: "5O", MARRON: "ZG" },
            13: { BLEU: "KC", NOIR: "ZB", ORANGE: "F2", VERT: "4I", ROSE: "C3", GRIS: "EY", ROUGE: "MF", MARRON: "O7" },
            14: { BLEU: "BO", NOIR: "EM", ORANGE: "IT", VERT: "DN", ROSE: "AV", GRIS: "K5", ROUGE: "RP", MARRON: "CY" },
            15: { BLEU: "AE", NOIR: "JQ", ORANGE: "II", VERT: "LM", ROSE: "0T", GRIS: "JR", ROUGE: "9U", MARRON: "V9" },
            16: { BLEU: "XF", NOIR: "9D", ORANGE: "ME", VERT: "PV", ROSE: "B1", GRIS: "SX", ROUGE: "1M", MARRON: "8N" },
            17: { BLEU: "A8", NOIR: "6L", ORANGE: "6K", VERT: "2H", ROSE: "IT", GRIS: "33", ROUGE: "91", MARRON: "2D" },
            18: { BLEU: "B0", NOIR: "3G", ORANGE: "5V", VERT: "9V", ROSE: "AT", GRIS: "RY", ROUGE: "HZ", MARRON: "IG" },
            19: { BLEU: "T0", NOIR: "FD", ORANGE: "82", VERT: "XC", ROSE: "G5", GRIS: "A0", ROUGE: "JK", MARRON: "K5" },
            20: { BLEU: "QP", NOIR: "82", ORANGE: "VV", VERT: "GU", ROSE: "XK", GRIS: "OZ", ROUGE: "NB", MARRON: "GQ" },
            21: { BLEU: "IN", NOIR: "W9", ORANGE: "CZ", VERT: "CJ", ROSE: "0A", GRIS: "F1", ROUGE: "RN", MARRON: "JE" },
            22: { BLEU: "OX", NOIR: "57", ORANGE: "T7", VERT: "KB", ROSE: "6", GRIS: "VD", ROUGE: "YT", MARRON: "EL" },
            23: { BLEU: "PT", NOIR: "95", ORANGE: "LU", VERT: "M5", ROSE: "X0", GRIS: "G8", ROUGE: "PM", MARRON: "DJ" },
            24: { BLEU: "5V", NOIR: "PF", ORANGE: "WM", VERT: "DQ", ROSE: "28", GRIS: "EV", ROUGE: "PE", MARRON: "QL" },
            25: { BLEU: "UI", NOIR: "52", ORANGE: "VR", VERT: "VF", ROSE: "8V", GRIS: "46", ROUGE: "FP", MARRON: "BJ" },
            26: { BLEU: "RJ", NOIR: "RI", ORANGE: "FL", VERT: "SG", ROSE: "WR", GRIS: "MF", ROUGE: "GP", MARRON: "93" },
            27: { BLEU: "C4", NOIR: "HC", ORANGE: "UC", VERT: "PV", ROSE: "IH", GRIS: "AP", ROUGE: "YL", MARRON: "JL" },
            28: { BLEU: "GF", NOIR: "BZ", ORANGE: "G0", VERT: "3V", ROSE: "LK", GRIS: "VD", ROUGE: "N1", MARRON: "4L" },
            29: { BLEU: "VQ", NOIR: "P3", ORANGE: "3Y", VERT: "9D", ROSE: "85", GRIS: "8J", ROUGE: "0S", MARRON: "SG" },
            30: { BLEU: "DZ", NOIR: "O3", ORANGE: "9B", VERT: "ZP", ROSE: "S8", GRIS: "ST", ROUGE: "HD", MARRON: "5T" },
            51: { BLEU: "1X", NOIR: "2C", ORANGE: "3A", VERT: "8N", ROSE: "4T", GRIS: "6S", ROUGE: "5K", MARRON: "7W" },
            52: { BLEU: "4B", NOIR: "7F", ORANGE: "6Z", VERT: "1M", ROSE: "2J", GRIS: "8P", ROUGE: "3U", MARRON: "5O" },
            53: { BLEU: "2N", NOIR: "5R", ORANGE: "8L", VERT: "4D", ROSE: "7E", GRIS: "1G", ROUGE: "6C", MARRON: "3Y" },
            54: { BLEU: "7M", NOIR: "3H", ORANGE: "1K", VERT: "2W", ROSE: "5A", GRIS: "4X", ROUGE: "8F", MARRON: "6T" },
            55: { BLEU: "5D", NOIR: "6S", ORANGE: "4U", VERT: "7O", ROSE: "3Z", GRIS: "2B", ROUGE: "1R", MARRON: "8J" },
            56: { BLEU: "3W", NOIR: "8P", ORANGE: "2C", VERT: "5Y", ROSE: "6L", GRIS: "7N", ROUGE: "4H", MARRON: "1E" },
            57: { BLEU: "1O", NOIR: "3G", ORANGE: "2F", VERT: "6T", ROSE: "8K", GRIS: "7M", ROUGE: "5S", MARRON: "4A" },
            58: { BLEU: "3Y", NOIR: "2X", ORANGE: "8R", VERT: "5J", ROSE: "7U", GRIS: "6D", ROUGE: "4P", MARRON: "1Z" },
            59: { BLEU: "2T", NOIR: "8B", ORANGE: "7H", VERT: "4E", ROSE: "6C", GRIS: "5W", ROUGE: "1G", MARRON: "3L" },
            60: { BLEU: "8J", NOIR: "7N", ORANGE: "6S", VERT: "1A", ROSE: "5F", GRIS: "4O", ROUGE: "3X", MARRON: "2K" },
            62: { BLEU: "6A", NOIR: "5D", ORANGE: "4G", VERT: "2L", ROSE: "1H", GRIS: "3T", ROUGE: "8N", MARRON: "7C" },
            63: { BLEU: "5Z", NOIR: "4W", ORANGE: "1X", VERT: "8K", ROSE: "3S", GRIS: "2J", ROUGE: "7M", MARRON: "6F" },
            65: { BLEU: "1K", NOIR: "3Y", ORANGE: "6N", VERT: "4C", ROSE: "8G", GRIS: "2A", ROUGE: "7W", MARRON: "5H" },
            67: { BLEU: "5C", NOIR: "7J", ORANGE: "2D", VERT: "8R", ROSE: "3B", GRIS: "1L", ROUGE: "4Y", MARRON: "6P" },
            68: { BLEU: "8F", NOIR: "1E", ORANGE: "7W", VERT: "6H", ROSE: "2N", GRIS: "4K", ROUGE: "5T", MARRON: "3G" },
            69: { BLEU: "6R", NOIR: "4A", ORANGE: "1O", VERT: "3S", ROSE: "7M", GRIS: "5U", ROUGE: "8J", MARRON: "2X" },
            70: { BLEU: "3H", NOIR: "5Z", ORANGE: "4Y", VERT: "2P", ROSE: "1D", GRIS: "8C", ROUGE: "6E", MARRON: "7B" },
            71: { BLEU: "2S", NOIR: "8L", ORANGE: "5T", VERT: "7G", ROSE: "4W", GRIS: "6F", ROUGE: "3A", MARRON: "1N" },
            72: { BLEU: "7P", NOIR: "6K", ORANGE: "8J", VERT: "1X", ROSE: "5O", GRIS: "3R", ROUGE: "2Z", MARRON: "4M" },
            73: { BLEU: "2G", NOIR: "4U", ORANGE: "3E", VERT: "1B", ROSE: "8Y", GRIS: "5H", ROUGE: "6L", MARRON: "7D" },
            75: { BLEU: "3B", NOIR: "2F", ORANGE: "1Z", VERT: "4M", ROSE: "6J", GRIS: "7P", ROUGE: "5U", MARRON: "8O" },
            76: { BLEU: "5N", NOIR: "6R", ORANGE: "7L", VERT: "8D", ROSE: "3E", GRIS: "4G", ROUGE: "1C", MARRON: "2Y" },
            77: { BLEU: "1M", NOIR: "3H", ORANGE: "4K", VERT: "2W", ROSE: "5A", GRIS: "8X", ROUGE: "7F", MARRON: "6T" },
            78: { BLEU: "7D", NOIR: "5S", ORANGE: "8U", VERT: "6O", ROSE: "1Z", GRIS: "2B", ROUGE: "4R", MARRON: "3J" },
            80: { BLEU: "8O", NOIR: "7G", ORANGE: "6F", VERT: "5T", ROSE: "4K", GRIS: "3M", ROUGE: "2S", MARRON: "1A" },
            81: { BLEU: "6Y", NOIR: "1X", ORANGE: "7R", VERT: "3J", ROSE: "8U", GRIS: "5D", ROUGE: "2P", MARRON: "4Z" },
            82: { BLEU: "8T", NOIR: "4B", ORANGE: "5H", VERT: "6E", ROSE: "1C", GRIS: "3W", ROUGE: "7G", MARRON: "2L" },
            83: { BLEU: "1J", NOIR: "2N", ORANGE: "3S", VERT: "8A", ROSE: "4F", GRIS: "6O", ROUGE: "5X", MARRON: "7K" },
            85: { BLEU: "2A", NOIR: "5D", ORANGE: "8G", VERT: "4L", ROSE: "7H", GRIS: "1T", ROUGE: "6N", MARRON: "3C" },
            86: { BLEU: "7Z", NOIR: "3W", ORANGE: "1X", VERT: "2K", ROSE: "5S", GRIS: "4J", ROUGE: "8M", MARRON: "6F" },
            87: { BLEU: "5L", NOIR: "6O", ORANGE: "4B", VERT: "7U", ROSE: "3P", GRIS: "2E", ROUGE: "1D", MARRON: "8R" },
            89: { BLEU: "1U", NOIR: "3T", ORANGE: "2M", VERT: "6F", ROSE: "8X", GRIS: "7Z", ROUGE: "5O", MARRON: "4S" },
            90: { BLEU: "3C", NOIR: "2J", ORANGE: "8D", VERT: "5R", ROSE: "7B", GRIS: "6L", ROUGE: "4Y", MARRON: "1P" },
            91: { BLEU: "2F", NOIR: "8E", ORANGE: "7W", VERT: "4H", ROSE: "6N", GRIS: "5K", ROUGE: "1T", MARRON: "3G" },
            92: { BLEU: "8R", NOIR: "7A", ORANGE: "6O", VERT: "1S", ROSE: "5M", GRIS: "4U", ROUGE: "3J", MARRON: "2X" },
            93: { BLEU: "7H", NOIR: "6Z", ORANGE: "5Y", VERT: "3P", ROSE: "4D", GRIS: "1C", ROUGE: "2E", MARRON: "8B" },
            94: { BLEU: "6S", NOIR: "5L", ORANGE: "4T", VERT: "2G", ROSE: "1W", GRIS: "3F", ROUGE: "8A", MARRON: "7N" },
            95: { BLEU: "5P", NOIR: "4K", ORANGE: "1J", VERT: "8X", ROSE: "3O", GRIS: "2R", ROUGE: "7Z", MARRON: "6M" },
            96: { BLEU: "4G", NOIR: "1U", ORANGE: "3E", VERT: "7B", ROSE: "2Y", GRIS: "8H", ROUGE: "6L", MARRON: "5D" },
            97: { BLEU: "1X", NOIR: "3C", ORANGE: "6A", VERT: "4N", ROSE: "8T", GRIS: "2S", ROUGE: "7K", MARRON: "5W" },
            98: { BLEU: "4B", NOIR: "2F", ORANGE: "3Z", VERT: "5M", ROSE: "6J", GRIS: "7P", ROUGE: "1U", MARRON: "8O" },
            99: { BLEU: "5N", NOIR: "7R", ORANGE: "2L", VERT: "8D", ROSE: "3E", GRIS: "1G", ROUGE: "4C", MARRON: "6Y" },
            100: { BLEU: "8M", NOIR: "1H", ORANGE: "7K", VERT: "6W", ROSE: "2A", GRIS: "4X", ROUGE: "5F", MARRON: "3T" }};
const NOMBRE_ELEVES_PAR_CLASSE = 28;
const NOMBRE_BALISES_SAISIE = 5;
const COULEURS_BALISES = ["NOIR", "ORANGE", "VERT", "ROSE", "GRIS", "ROUGE", "MARRON", "BLEU"];
const CLASSES_DISPONIBLES = ["4eA", "4eB", "4eC", "4eD", "6A", "6B", "6C", "6D"];
const NOMBRE_PARCOURS = 20;

const TEACHER_CODE = '16170'; // Le code d'acc√®s pour la vue professeur

// --- D√âBUT DE LA SECTION FIREBASE ---
// Configuration Firebase - Remplacez par vos propres identifiants si n√©cessaire
const firebaseConfig = {
  apiKey: "AIzaSyD3Cu1X0_JSF1qePFRzcq-RY-MYTB32a-8", // C'est un exemple, utilisez votre cl√© r√©elle
  authDomain: "co-rouillac.firebaseapp.com",
  projectId: "co-rouillac",
  storageBucket: "co-rouillac.firebasestorage.app",
  messagingSenderId: "729910930573",
  appId: "1:729910930573:web:f8c0e93c702416fcd446c4"
};

// Initialisation de Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let unsubscribeFromResults = null;
let currentActiveLessonId = null; // Variable globale mise √† jour en temps r√©el

// --- FIN DE LA SECTION FIREBASE ---


// --- S√âLECTION DES √âL√âMENTS DU DOM ---
const studentView = document.getElementById('studentView');
const teacherDashboard = document.getElementById('teacherDashboard');
const studentViewBtn = document.getElementById('studentViewBtn');
const teacherViewBtn = document.getElementById('teacherViewBtn');
const classeSelect = document.getElementById('classeSelect');
const teamSelect = document.getElementById('teamSelect');
const parcoursSelect = document.getElementById('parcoursSelect');
const durationMinutesInput = document.getElementById('durationMinutes');
const durationSecondsInput = document.getElementById('durationSeconds');
const tagEntriesContainer = document.getElementById('tagEntriesContainer');
const tagForm = document.getElementById('tagForm');
const resultsList = document.getElementById('resultsList');
const scoreArea = document.getElementById('scoreArea');
const globalError = document.getElementById('globalError');

// √âl√©ments pour la connexion professeur
const teacherLoginContainer = document.getElementById('teacherLoginContainer');
const teacherCodeInput = document.getElementById('teacherCodeInput');
const teacherCodeSubmitBtn = document.getElementById('teacherCodeSubmitBtn');
const teacherCodeError = document.getElementById('teacherCodeError');

// √âl√©ments du tableau de bord professeur
const startLessonBtn = document.getElementById('startLessonBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const lessonStatus = document.getElementById('lessonStatus');
const resultsTableBody = document.getElementById('resultsTableBody');



// --- LOGIQUE DE GESTION DES VUES ---
/**
 * Affiche la vue sp√©cifi√©e (√©l√®ve, professeur ou connexion professeur) et met √† jour les boutons de navigation.
 * @param {string} viewName - Le nom de la vue √† afficher ('student', 'teacher', 'teacherLogin').
 */
function showView(viewName) {
    // Masque toutes les vues possibles par d√©faut
    studentView.classList.add('hidden');
    teacherDashboard.classList.add('hidden');
    teacherLoginContainer.classList.add('hidden');

    // R√©initialise l'√©tat actif des boutons de vue
    studentViewBtn.classList.remove('active');
    teacherViewBtn.classList.remove('active');

    // Affiche la vue demand√©e et active le bouton correspondant
    if (viewName === 'student') {
        studentView.classList.remove('hidden');
        studentViewBtn.classList.add('active');
        teacherCodeError.textContent = '';
        teacherCodeInput.value = '';
        // Le bandeau est g√©r√© par le listener global initialis√© au d√©marrage
    } else if (viewName === 'teacher') {
        teacherDashboard.classList.remove('hidden');
        teacherViewBtn.classList.add('active');
    } else if (viewName === 'teacherLogin') {
        teacherLoginContainer.classList.remove('hidden');
        teacherViewBtn.classList.add('active'); // Maintient le bouton professeur actif pendant la connexion
        teacherCodeError.textContent = ''; // Efface les messages d'erreur pr√©c√©dents
        teacherCodeInput.value = ''; // Vide le champ du code
        teacherCodeInput.focus(); // Met le focus sur le champ de saisie
    }
}

// Gestionnaire de clic pour le bouton "Vue √âl√®ve"
studentViewBtn.addEventListener('click', () => showView('student'));

// Gestionnaire de clic pour le bouton "Vue Professeur" (d√©clenche la demande de code)
teacherViewBtn.addEventListener('click', () => showView('teacherLogin'));

// Gestionnaire de clic pour le bouton de soumission du code professeur
teacherCodeSubmitBtn.addEventListener('click', () => {
    const enteredCode = teacherCodeInput.value.trim();
    if (enteredCode === TEACHER_CODE) {
        showView('teacher'); // Accorde l'acc√®s au tableau de bord professeur
    } else {
        teacherCodeError.textContent = 'Code incorrect. Veuillez r√©essayer.';
        teacherCodeInput.value = ''; // Vide le champ apr√®s une erreur
        teacherCodeInput.focus(); // Remet le focus sur le champ
    }
});

// Permet de valider le code professeur avec la touche Entr√©e
teacherCodeInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
        teacherCodeSubmitBtn.click(); // Simule un clic sur le bouton de validation
    }
});


// --- FONCTIONS DE G√âN√âRATION DYNAMIQUE (VUE √âL√àVE) ---
/**
 * Peuple un √©l√©ment <select> avec des options num√©riques.
 * @param {HTMLElement} element - L'√©l√©ment <select> √† peupler.
 * @param {number} start - La valeur de d√©but des options.
 * @param {number} end - La valeur de fin des options.
 * @param {string} [prefix=''] - Un pr√©fixe √† ajouter au texte de l'option (ex: '√âl√®ve ').
 * @param {string} placeholder - Le texte de l'option d√©sactiv√©e par d√©faut.
 * @param {boolean} [padZero=false] - Indique si les nombres doivent √™tre format√©s avec un z√©ro initial (ex: '05' au lieu de '5').
 */
function populateSelect(element, start, end, prefix = '', placeholder, padZero = false) {
    element.innerHTML = `<option value="" disabled selected>--- ${placeholder} ---</option>`;
    for (let i = start; i <= end; i++) {
        const option = document.createElement('option');
        const displayValue = padZero ? String(i).padStart(2, '0') : String(i);
        option.value = `${prefix}${displayValue}`; // La valeur contient le pr√©fixe
        option.textContent = `${prefix}${displayValue}`; // Le texte affich√© contient le pr√©fixe
        element.appendChild(option);
    }
}

/** Peuple le menu d√©roulant des classes. */
function populateClasses() {
    classeSelect.innerHTML = '<option value="" disabled selected>--- S√©lectionner ---</option>';
    CLASSES_DISPONIBLES.forEach(c => {
         const option = document.createElement('option');
         option.value = c;
         option.textContent = c;
         classeSelect.appendChild(option);
    });
}

/**
 * Cr√©e une entr√©e de balise dynamique avec num√©ro, couleur et code.
 * @param {number} index - L'index de la balise (pour l'ID et l'affichage).
 */
function createTagEntry(index) {
    const groupDiv = document.createElement('div');
    groupDiv.classList.add('tag-group');
    let numBaliseOptions = '';
    for (let k = 1; k <= 100; k++) {
        numBaliseOptions += `<option value="${k}">${k}</option>`;
    }
    groupDiv.innerHTML = `
        <div class="tag-group-header">üìç Balise ${index + 1}</div>
        <div class="tag-inputs">
            <div><label>#Ô∏è‚É£ N¬∞</label><select id="baliseNum${index}"><option value="" disabled selected>N¬∞</option>${numBaliseOptions}</select></div>
            <div><label>üé® Coul.</label><select id="baliseCouleur${index}"><option value="" disabled selected>Coul.</option>${COULEURS_BALISES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
            <div><label>üîë Code</label><input type="text" id="baliseCode${index}" placeholder="Code"></div>
        </div>`;
    tagEntriesContainer.appendChild(groupDiv);
}


// --- FONCTIONS DU TABLEAU DE BORD PROFESSEUR ---
/**
 * D√©marre une nouvelle le√ßon en demandant un nom et initialise l'√©coute des r√©sultats Firebase.
 */
startLessonBtn.addEventListener('click', async () => {
    const lessonName = prompt("Entrez un nom pour cette le√ßon (ex: '4eA Lundi Matin', 'S√©ance 1')", "Le√ßon du jour");
    if (!lessonName) return;

    const now = new Date();
    const lessonId = `lecon_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${lessonName.replace(/\s+/g, '-')}`;
    
    localStorage.setItem('currentLessonId', lessonId);
    localStorage.setItem('currentLessonName', lessonName);

    // √âcriture dans Firestore sans auth
    try {
        await db.collection('config').doc('activeLesson').set({
            lessonId: lessonId,
            lessonName: lessonName,
            startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        listenToResults(lessonId);
        alert('Lecon "' + lessonName + '" demarree ! Les tablettes peuvent maintenant envoyer des resultats.');
    } catch(e) {
        console.error("Erreur lors du lancement de la lecon :", e);
        alert("Erreur : " + e.code + " - " + e.message);
    }
});

function listenToResults(lessonId) {
    if (unsubscribeFromResults) {
        unsubscribeFromResults();
    }
    
    const lessonName = localStorage.getItem('currentLessonName') || lessonId;
    lessonStatus.textContent = `Le√ßon en cours : "${lessonName}"`;
    resultsTableBody.innerHTML = '';
    exportPdfBtn.disabled = false;

    const resultsCollection = db.collection('lecons').doc(lessonId).collection('resultats');
    
    // Sans orderBy pour √©viter les erreurs d'index Firestore
    unsubscribeFromResults = resultsCollection.onSnapshot(snapshot => {
        resultsTableBody.innerHTML = '';
        const docs = [];
        snapshot.forEach(doc => docs.push(doc.data()));
        // Tri c√¥t√© client (g√®re aussi le timestamp null pendant l'√©criture)
        docs.sort((a, b) => {
            const tA = a.timestamp ? a.timestamp.seconds : 0;
            const tB = b.timestamp ? b.timestamp.seconds : 0;
            return tA - tB;
        });
        docs.forEach(data => {
            const newRow = resultsTableBody.insertRow();
            const heureStr = data.timestamp
                ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString('fr-FR')
                : '...';
            newRow.innerHTML = `
                <td>${data.classe || ''}</td>
                <td>${data.eleveId || ''}</td>
                <td>${data.parcoursId || ''}</td>
                <td>${data.scoreCorrectes}/${data.scoreTentatives}</td>
                <td>${String(data.tempsMinutes).padStart(2, '0')}:${String(data.tempsSecondes).padStart(2, '0')}</td>
                <td>${heureStr}</td>
            `;
        });
    }, error => {
        console.error("Erreur Firestore : ", error.code, error.message);
        lessonStatus.textContent = `Erreur Firestore : ${error.code} - ${error.message}`;
    });
}

/** Exporte les r√©sultats affich√©s dans le tableau en format PDF. */
exportPdfBtn.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const lessonName = localStorage.getItem('currentLessonName') || 'R√©sultats de la le√ßon';
    doc.text(`R√©sultats de la Course d'Orientation - ${lessonName}`, 14, 20);

    // Ent√™tes du tableau PDF (modifi√© pour Score et Temps)
    const headers = [['Classe', '√âl√®ve', 'Parcours', 'Score', 'Temps', 'SAUVEGARDE']];

    // Donn√©es du tableau PDF
    const data = [];
    const rows = resultsTableBody.querySelectorAll("tr");

    rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        // Le score est d√©j√† format√© comme "X/Y" dans la 4√®me colonne (index 3) du tableau HTML
        const score = cols[3].innerText; 
        // Le temps est d√©j√† format√© comme "MM:SS" dans la 5√®me colonne (index 4) du tableau HTML
        const temps = cols[4].innerText;
        
        data.push([
            cols[0].innerText, // Classe
            cols[1].innerText, // √âl√®ve
            cols[2].innerText, // Parcours
            score,             // Score (d√©j√† format√©)
            temps,             // Temps (d√©j√† format√©)
            cols[5].innerText  // Sauvegarde
        ]);
    });

    // G√©n√©rer le tableau dans le PDF
    doc.autoTable({
        startY: 30, // Position de d√©part du tableau apr√®s le titre
        head: headers,
        body: data,
        theme: 'striped', // Style du tableau (options: 'striped', 'grid', 'plain')
        headStyles: { fillColor: [88, 129, 87] }, // Couleur d'en-t√™te (vert for√™t)
        styles: { fontSize: 9 },
        columnStyles: {
            0: { cellWidth: 25 }, // Classe
            1: { cellWidth: 25 }, // √âl√®ve
            2: { cellWidth: 25 }, // Parcours
            3: { cellWidth: 25 }, // Score
            4: { cellWidth: 25 }, // Temps
            5: { cellWidth: 35 }, // Heure Sauvegarde
        }
    });

    // T√©l√©charger le PDF
    doc.save(`resultats_${lessonName.replace(/\s+/g, '_')}.pdf`);
});


// --- LOGIQUE DE V√âRIFICATION ET D'ENVOI (VUE √âL√àVE) ---
/** G√®re la soumission du formulaire de l'√©l√®ve. */
tagForm.addEventListener('submit', async function(event) {
    event.preventDefault(); // Emp√™che le rechargement de la page par d√©faut
    clearMessages(); // Efface les messages pr√©c√©dents et la zone de score

    // 1. R√©cup√©ration de la le√ßon active via la variable globale (mise √† jour en temps r√©el)
    const currentLessonId = currentActiveLessonId || localStorage.getItem('currentLessonId');
    
    if (!currentLessonId) {
        showGlobalError("Aucune lecon n'est demarree. Le professeur doit d'abord demarrer une nouvelle lecon.");
        return;
    }

    // R√©cup√©ration des donn√©es du formulaire
    const eleveId = teamSelect.value;
    const classe = classeSelect.value;
    const parcoursId = parcoursSelect.value;
    const durationM = durationMinutesInput.value;
    const durationS = durationSecondsInput.value;
    
    // V√©rification que tous les champs obligatoires sont remplis
    if (!eleveId || !classe || !parcoursId || durationM === "" || durationS === "") {
        showGlobalError("Veuillez remplir tous les champs d'identification et de temps.");
        return;
    }

    // 2. Validation du temps saisi
    const minutes = parseInt(durationM);
    const secondes = parseInt(durationS);
    if (isNaN(minutes) || isNaN(secondes) || secondes < 0 || secondes > 59 || minutes < 0) {
        showGlobalError("Temps invalide : les secondes doivent √™tre entre 0 et 59.");
        return;
    }
    if (minutes === 0 && secondes === 0) {
        showGlobalError("Le temps de course ne peut pas √™tre z√©ro.");
        return;
    }

    // 3. V√©rification des balises et calcul du score
    const { correctes, tentatives } = verifyTags();
    
    if (tentatives === 0) { // Si aucune balise n'a √©t√© saisie
        showGlobalError("Veuillez saisir au moins une balise.");
        return;
    }

    displayLocalResults(correctes, tentatives, minutes, secondes); // Affiche les r√©sultats sur la page

    // 4. Pr√©paration des donn√©es pour Firebase
    const resultData = {
        classe: classe,
        eleveId: eleveId,
        parcoursId: parcoursId,
        scoreCorrectes: correctes,
        scoreTentatives: tentatives,
        tempsMinutes: minutes,
        tempsSecondes: secondes,
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Horodatage du serveur pour la coh√©rence
    };

    // 5. Envoi des donn√©es √† Firebase
    try {
        submitBtn.disabled = true; // D√©sactive le bouton pour √©viter les envois multiples
        submitBtn.textContent = "Envoi en cours..."; // Change le texte du bouton
        const docRef = await db.collection('lecons').doc(currentLessonId).collection('resultats').add(resultData);
        console.log("Document √©crit avec ID: ", docRef.id);

        // Affiche un message de succ√®s non bloquant
        showGlobalError("R√©sultat envoy√© avec succ√®s !");

        // R√©initialise le formulaire automatiquement apr√®s l'envoi
        setTimeout(() => {
            resetFormForNewEntry();
        }, 2000);

    } catch (error) {
        console.error("Erreur d'√©criture du document: ", error);
        showGlobalError("ERREUR: Impossible d'envoyer les r√©sultats. V√©rifiez la connexion internet.");
    } finally {
        submitBtn.disabled = false; // R√©active le bouton
        submitBtn.textContent = "üöÄ V√©rifier et Envoyer le R√©sultat !"; // R√©tablit le texte du bouton
    }
});

/**
 * Calcule la dur√©e entre une heure de d√©but et une heure de fin donn√©es en minutes et secondes.
 * @param {string|number} startMin - Minutes de d√©but.
 * @param {string|number} startSec - Secondes de d√©but.
 * @param {string|number} endMin - Minutes de fin.
 * @param {string|number} endSec - Secondes de fin.
 * @returns {{minutes: number, secondes: number, isValid: boolean}} L'objet de temps calcul√©.
 */
function calculateTime(startMin, startSec, endMin, endSec) {
    const totalStartSeconds = parseInt(startMin) * 60 + parseInt(startSec);
    const totalEndSeconds = parseInt(endMin) * 60 + parseInt(endSec);

    let diffSeconds = totalEndSeconds - totalStartSeconds;

    if (diffSeconds < 0) {
        return { minutes: 0, secondes: 0, isValid: false }; // L'arriv√©e est avant le d√©part
    }

    const minutes = Math.floor(diffSeconds / 60);
    const secondes = diffSeconds % 60;

    return { minutes, secondes, isValid: true };
}

/**
 * V√©rifie les balises saisies par l'√©l√®ve par rapport √† la base de donn√©es.
 * Affiche le statut de chaque balise dans la liste des r√©sultats.
 * @returns {{correctes: number, tentatives: number}} Le nombre de balises correctes et tent√©es.
 */
function verifyTags() {
    let balisesValidesTrouvees = 0;
    let attemptedTags = 0;
    resultsList.innerHTML = ''; // Vide la liste des r√©sultats pr√©c√©dents
    
    for (let i = 0; i < NOMBRE_BALISES_SAISIE; i++) {
        const num = document.getElementById(`baliseNum${i}`).value;
        const couleur = document.getElementById(`baliseCouleur${i}`).value;
        const code = document.getElementById(`baliseCode${i}`).value.trim().toUpperCase();

        // Ignore la balise si tous ses champs sont vides
        if (!num && !couleur && !code) continue;
        
        attemptedTags++; // Incr√©mente le compteur de balises tent√©es

        let message, resultClass;
        // V√©rifie si tous les champs de la balise sont remplis pour la validation
        if (num && couleur && code) {
            // Convertit le num√©ro de balise en entier pour la recherche dans DONNEES_SHEET
            const numInt = parseInt(num);
            // V√©rifie si la balise existe dans les donn√©es et si le code correspond
            if (DONNEES_SHEET[numInt] && DONNEES_SHEET[numInt][couleur] === code) {
                message = `Balise ${num} (${couleur}): ‚úÖ CORRECT !`;
                resultClass = 'result-correct';
                balisesValidesTrouvees++;
            } else {
                message = `Balise ${num} (${couleur}): ‚ùå INCORRECT.`;
                resultClass = 'result-incorrect';
            }
        } else {
            message = `Balise ${i+1}: ‚ö†Ô∏è Infos manquantes.`; // Message si des champs sont manquants
            resultClass = 'result-warning';
        }
        const li = document.createElement('li');
        li.textContent = message;
        li.className = resultClass;
        resultsList.appendChild(li); // Ajoute le r√©sultat √† la liste
    }
    return { correctes: balisesValidesTrouvees, tentatives: attemptedTags };
}

/**
 * Affiche le score et le temps calcul√© dans la zone de score.
 * @param {number} correctes - Nombre de balises correctes.
 * @param {number} tentatives - Nombre total de balises tent√©es.
 * @param {number} minutes - Minutes de temps de course.
 * @param {number} secondes - Secondes de temps de course.
 */
function displayLocalResults(correctes, tentatives, minutes, secondes) {
    if (tentatives > 0) {
        scoreArea.innerHTML = `üèÜ Score: ${correctes} / ${tentatives}<br>‚è±Ô∏è Temps: ${minutes}m ${secondes}s`;
        scoreArea.style.display = 'block'; // Rend la zone de score visible
    }
}

/**
 * Affiche un message d'erreur/information global en haut de la page.
 * @param {string} message - Le message √† afficher.
 */
function showGlobalError(message) {
    globalError.textContent = `‚ö†Ô∏è ${message}`;
    globalError.classList.remove('hidden'); // Rend le message visible
}

/**
 * Efface tous les messages d'erreur et de r√©sultats, et masque la zone de score.
 */
function clearMessages() {
    globalError.textContent = '';
    globalError.classList.add('hidden'); // Masque le message global
    resultsList.innerHTML = ''; // Vide la liste des r√©sultats des balises
    scoreArea.style.display = 'none'; // Masque la zone de score
}

/**
 * R√©initialise les champs du formulaire (temps et balises) pour une nouvelle saisie.
 * Est appel√©e lors d'un changement de s√©lection ou du clic sur le bouton "Sauvegarder".
 */
function resetFormForNewEntry() {
    // R√©initialise les champs de temps
    durationMinutesInput.value = '';
    durationSecondsInput.value = '';

    // R√©initialise les champs des balises
    for (let i = 0; i < NOMBRE_BALISES_SAISIE; i++) {
        document.getElementById(`baliseNum${i}`).value = '';
        document.getElementById(`baliseCouleur${i}`).value = '';
        document.getElementById(`baliseCode${i}`).value = '';
    }
    
    clearMessages(); // Efface les messages d'erreur/r√©sultats
}


// --- INITIALISATION AU CHARGEMENT DE LA PAGE ---
document.addEventListener('DOMContentLoaded', () => {

    // 1. Interface (pas besoin d'auth)
    populateClasses();
    populateSelect(teamSelect, 1, NOMBRE_ELEVES_PAR_CLASSE, 'Eleve ', 'Selectionner');
    populateSelect(parcoursSelect, 1, NOMBRE_PARCOURS, 'Parcours ', 'Selectionner');
    for (let i = 0; i < NOMBRE_BALISES_SAISIE; i++) {
        createTagEntry(i);
    }
    classeSelect.addEventListener('change', resetFormForNewEntry);
    teamSelect.addEventListener('change', resetFormForNewEntry);
    parcoursSelect.addEventListener('change', resetFormForNewEntry);

    // 2. Vue √©l√®ve par d√©faut
    studentView.classList.remove('hidden');
    studentViewBtn.classList.add('active');
    teacherDashboard.classList.add('hidden');
    teacherLoginContainer.classList.add('hidden');

    const banner = document.getElementById('activeLessonBanner');
    banner.textContent = 'Connexion en cours...';
    banner.style.backgroundColor = '#888';

    // Connexion directe √† Firestore sans auth
    // Bandeau : √©coute temps r√©el de la le√ßon active
    db.collection('config').doc('activeLesson').onSnapshot(doc => {
        if (doc.exists && doc.data().lessonName) {
            currentActiveLessonId = doc.data().lessonId; // Mise √† jour globale
            banner.textContent = 'Lecon en cours : ' + doc.data().lessonName;
            banner.style.backgroundColor = '#344e41';
        } else {
            currentActiveLessonId = null;
            banner.textContent = 'Aucune lecon demarree - attendez le professeur';
            banner.style.backgroundColor = '#e76f51';
        }
    }, err => {
        banner.textContent = 'Erreur : ' + err.code;
        banner.style.backgroundColor = '#c62828';
    });

    // Restaure l'√©coute du tableau de bord si le prof recharge la page
    const storedLessonId = localStorage.getItem('currentLessonId');
    if (storedLessonId) {
        listenToResults(storedLessonId);
    }
});

</script>
</body>
</html>
